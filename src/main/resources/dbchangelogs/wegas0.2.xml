<?xml version="1.0" encoding="ISO-8859-1"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet author="CiGit" id="2">
        <comment>
            Version 0.2 security
        </comment>
        <createTable tableName="abstractaccount">
            <column name="id" type="int8">
                <constraints nullable="false" primaryKey="true" primaryKeyName="abstractaccount_pkey"/>
            </column>
            <column name="dtype" type="VARCHAR(31)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="firstname" type="VARCHAR(255)"/>
            <column name="lastname" type="VARCHAR(255)"/>
            <column name="username" type="VARCHAR(100)"/>
            <column name="user_id" type="int8"/>
            <column name="passwordhex" type="VARCHAR(255)"/>
            <column name="salt" type="VARCHAR(255)"/>
        </createTable>

        <createTable tableName="abstractaccount_permissions">
            <column name="abstractaccount_id" type="int8"/>
            <column name="permissions" type="VARCHAR(255)"/>
        </createTable>

        <createTable tableName="abstractaccount_roles">
            <column name="abstractaccount_id" type="int8">
                <constraints nullable="false"/>
            </column>
            <column name="roles_id" type="int8">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="role_permissions">
            <column name="role_id" type="int8"/>
            <column name="permissions" type="VARCHAR(255)"/>
        </createTable>

        <createTable tableName="roles">
            <column name="id" type="int8">
                <constraints nullable="false" primaryKey="true" primaryKeyName="roles_pkey"/>
            </column>
            <column name="description" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(100)"/>
        </createTable>

        <addPrimaryKey columnNames="abstractaccount_id, roles_id" constraintName="abstractaccount_roles_pkey" tableName="abstractaccount_roles"/>
        <dropForeignKeyConstraint baseTableName="phone" baseTableSchemaName="public" constraintName="fk_phone_owner_id"/>
        <dropForeignKeyConstraint baseTableName="sec_roles_permissions" baseTableSchemaName="public" constraintName="fk_users_permissions_roles"/>
        <dropForeignKeyConstraint baseTableName="sec_users_roles" baseTableSchemaName="public" constraintName="fk_users_roles_roles"/>
        <dropForeignKeyConstraint baseTableName="sec_users_roles" baseTableSchemaName="public" constraintName="fk_users_roles_users"/>
        <addUniqueConstraint columnNames="email" constraintName="unq_abstractaccount_0" deferrable="false" disabled="false" initiallyDeferred="false" tableName="abstractaccount"/>
        <addUniqueConstraint columnNames="name" constraintName="unq_roles_0" deferrable="false" disabled="false" initiallyDeferred="false" tableName="roles"/>
        <dropUniqueConstraint constraintName="unq_test_0" tableName="test"/>
        <dropUniqueConstraint constraintName="unq_users_0" tableName="users"/>
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="abstractaccount" baseTableSchemaName="public" constraintName="fk_abstractaccount_user_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="users" referencedTableSchemaName="public" referencesUniqueColumn="false"/>
        <addForeignKeyConstraint baseColumnNames="abstractaccount_id" baseTableName="abstractaccount_permissions" baseTableSchemaName="public" constraintName="fk_abstractaccount_permissions_abstractaccount_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="abstractaccount" referencedTableSchemaName="public" referencesUniqueColumn="false"/>
        <addForeignKeyConstraint baseColumnNames="abstractaccount_id" baseTableName="abstractaccount_roles" baseTableSchemaName="public" constraintName="fk_abstractaccount_roles_abstractaccount_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="abstractaccount" referencedTableSchemaName="public" referencesUniqueColumn="false"/>
        <addForeignKeyConstraint baseColumnNames="roles_id" baseTableName="abstractaccount_roles" baseTableSchemaName="public" constraintName="fk_abstractaccount_roles_roles_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="roles" referencedTableSchemaName="public" referencesUniqueColumn="false"/>
        <addForeignKeyConstraint baseColumnNames="role_id" baseTableName="role_permissions" baseTableSchemaName="public" constraintName="fk_role_permissions_role_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="roles" referencedTableSchemaName="public" referencesUniqueColumn="false"/>
        <dropColumn columnName="name" tableName="users"/>
        <dropTable tableName="book"/>
        <dropTable tableName="phone"/>
        <dropTable tableName="sec_roles"/>
        <dropTable tableName="sec_roles_permissions"/>
        <dropTable tableName="sec_users"/>
        <dropTable tableName="sec_users_roles"/>
        <dropTable tableName="test"/>
    </changeSet>

    <changeSet id="3" author="meri" context="test">
        <comment>
            Create initial roles and root user.
        </comment>
        <insert tableName="roles">
            <column name="id" value="1" />
            <column name="name" value="Administrator" />
            <column name="description" value="" />
        </insert>
        <insert tableName="roles">
            <column name="id" value="2" />
            <column name="name" value="Registered" />
            <column name="description" value="" />
        </insert>
        <insert tableName="roles">
            <column name="id" value="3" />
            <column name="name" value="Guest" />
            <column name="description" value="" />
        </insert>

        <insert tableName="roles">
            <column name="id" value="4" />
            <column name="name" value="Scenarist" />
            <column name="description" value="" />
        </insert>
        <insert tableName="roles">
            <column name="id" value="5" />
            <column name="name" value="Animator" />
            <column name="description" value="" />
        </insert>
        <insert tableName="role_permissions">
            <column name="role_id" value="1" />
            <column name="permissions" value="GameModel:*:*" />
        </insert>
        <insert tableName="role_permissions">
            <column name="role_id" value="2" />
            <column name="permissions" value="Game:*:*" />
        </insert>


        <insert tableName="users">
            <column name="id" value="1" />
        </insert>
        <insert tableName="abstractaccount">
            <column name="id" value="1" />
            <column name="email" value="root@root.com" />
            <column name="dtype" value="JpaAccount" />
            <column name="user_id" value="1" />
            <column name="passwordhex" value="eb86410aa029d4f7b85c1b4c3c0a25736f9ae4806bd75d456a333d83b648f2ee" />
            <column name="salt" value="69066d73c2d03f85c5a8d3e39a2f184f" />
        </insert>

        <insert tableName="abstractaccount_roles">
            <column name="abstractaccount_id" value="1" />
            <column name="roles_id" value="1" />
        </insert>
        <insert tableName="abstractaccount_roles">
            <column name="abstractaccount_id" value="1" />
            <column name="roles_id" value="2" />
        </insert>
        <insert tableName="abstractaccount_roles">
            <column name="abstractaccount_id" value="1" />
            <column name="roles_id" value="3" />
        </insert>

    </changeSet>
</databaseChangeLog>