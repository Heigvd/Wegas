/*
 * Wegas
 * http://wegas.albasim.ch
 *
 * Copyright (c) 2013-2018  School of Business and Engineering Vaud, Comem, MEI
 * Licensed under the MIT License
 */
/**
 * @author Francois-Xavier Aeberhard <fx@red-agent.com>
 */
YUI.add('wegas-widgetmenu', function(Y) {
    "use strict";

    var HOST = "host", BOUNDINGBOX = "boundingBox",
        WidgetMenu, Menu, MenuBar;

    /**
     * @name Y.Plugin.WidgetMenu
     * @extends Y.Plugin.Base
     * @class Plugin to be attached to a Y.Widget, adds a menu
     *  that shows up when the target event is triggered (by default click). Uses
     *  a Y.Wegas.Menu to display the menu.
     * @constructor
     */
    WidgetMenu = function() {
        WidgetMenu.superclass.constructor.apply(this, arguments);
    };

    Y.extend(WidgetMenu, Y.Plugin.Base, {
        /** @lends Y.Plugin.WidgetMenu# */

        // *** Lifecycle methods *** //
        /**
         * @function
         * @private
         */
        initializer: function() {
            var host = this.get(HOST);

            if (host instanceof Y.Node) {                                       // 1st case: host is a Y.Node
                this.bind();
            } else if (host instanceof Y.Widget) {                              // 2nd case: host is a Y.Widiget
                this.afterHostEvent("render", this.bind);
            }

            this.after("childrenChange", function() {                           // On children attribute update
                if (this.menu) {
                    this.menu.destroyAll();
                    this.menu.add(this.get("children"));                        // update menu items
                }
            });
        },
        destructor: function() {
            this.menu && this.menu.destroy();
        },
        bind: function() {
            var node = this.get("targetNode");
            node.delegate(this.get("event"), function(e) {                      // Target event listener
                e.halt(true);                                                   // Prevent event from bubbling
                //Y.Plugin.EditEntityAction.allowDiscardingEdits(Y.bind(function() {
                this.show(e.target);
                this.fire("menuOpen", {domEvent: e});                        // Notify the parent the menu has been
                //}, this));                                                       // opened
            }, this.get("selector"), this);

            node.addClass("wegas-widgetmenu-hassubmenu");                       // Add submenu class
            if (this.get("menuCfg.points") && this.get("menuCfg.points")[0].indexOf("b") < 0) {
                node.addClass("wegas-widgetmenu-hassubmenuright");
            }
        },
        add: function(widget, index) {
            var children = this.get("children"),
                i = (typeof index === 'number') ? index : children.length,
                w = Y.Lang.isArray(widget) ? widget : [widget];
            Array.prototype.splice.apply(children, [i, 0].concat(w));
            this.set("children", children);
        },
        size: function() {
            return this.get("children").length;
        },
        /**
         * @function
         * @private
         */
        show: function(node) {
            var menu = this.getMenu();
            node = node || this.get("targetNode");
            menu.attachTo(node);                                                // Get a menu instance and attach it to
            // the target node
            menu.focus();
        },
        // *** Private methods *** //

        /**
         * @function
         * @private
         */
        getMenu: function() {
            if (!this.menu) {
                var cfg = this.get("menuCfg"),
                    host = this.get(HOST),
                    parent = host.get("parent"),
                    menu;
                cfg.zIndex = WidgetMenu.menuIndex;                              // Better exemple for this at
                // http://yuilibrary.com/yui/docs/overlay/overlay-stack.html
                WidgetMenu.menuIndex += 1;
                cfg.children = this.get("children");

                menu = new Menu(cfg);
                //   menu.on(["*:message", "*:showOverlay", "*:hideOverlay"], host.fire, host);
                menu.addTarget(this);

                //                menu.addTarget(this);                                           // Catch any event
                // generated by the menu
                menu._menuPlugin = this;
                this.menu = menu;                                               // Set up reference

                if (this.get("isSubmenu")) {                                    // Handle nested menus, events are forwarded to the parent widget
                    if (parent._menuPlugin) {
                        //menu.on(["*:message", "*:showOverlay", "*:hideOverlay"], parent._menuPlugin.fire,
                        // parent._menuPlugin);
                        menu.addTarget(parent._menuPlugin);                     // Forward events to parent plugin
                    }
                    menu.on("timerCanceled", parent.cancelMenuTimer, parent);
                    menu.on("timerStarted", parent.startMenuHideTimer, parent);
                }

                (host.get("contentBox") || host).delegate("mouseleave", function() {
                    this.menu.startMenuHideTimer(false);
                }, this.get("selector"), this);
            }
            return this.menu;
        }
    }, {
        /** @lends Y.Plugin.WidgetMenu */
        menuIndex: 50,
        NS: "menu",
        NAME: "widgetmenu",
        ATTRS: {
            isSubmenu: {
                readOnly: true,
                getter: function() {
                    var parent = this.get(HOST).get("parent");
                    return (parent && parent instanceof Menu);
                }
            },
            targetNode: {
                getter: function() {
                    var host = this.get(HOST),
                        node = (host instanceof Y.Widget) ?
                        host.get(BOUNDINGBOX) : host;
                    return node;
                }
            },
            children: {
                value: []
            },
            selector: {
                value: "*"
            },
            menuCfg: {
                value: {}
            },
            event: {
                value: "click"
            }
        }
    });
    Y.Plugin.WidgetMenu = WidgetMenu;

    /**
     *
     */
    MenuBar = Y.Base.create("menubar", Y.Widget, [Y.WidgetParent, Y.Wegas.Parent], {
        CONTENT_TEMPLATE: null
    }, {
        ATTRS: {
            defaultChildType: {
                value: Y.Wegas.Button
            }
        }
    });
    Y.namespace('Wegas').MenuBar = MenuBar;
    /**
     * @name Y.Wegas.Menu
     * @class Menu Widget, an positionnalbe overlay, intendend to be used by the menu plugin.
     * @contstructor
     * @extends Y.Widget
     * @augments Y.WidgetPosition
     * @augments Y.WidgetPositionAlign
     * @augments Y.WidgetStack
     * @augments Y.WidgetParent
     * @augments Y.WidgetPositionConstrain
     */
    Menu = Y.Base.create("menu", Y.Widget,
        [Y.WidgetParent, Y.WidgetPosition, Y.WidgetPositionAlign, Y.WidgetPositionConstrain, Y.WidgetStack], {
        /** @lends Y.Wegas.Menu# */
        CONTENT_TEMPLATE: null,
        // *** Lifecycle methods *** //
        initializer: function() {
            this.publish("cancelMenuTimer", {
                emitFacade: true
            });
        },
        renderUI: function() {
            var bb = this.get(BOUNDINGBOX);

            bb.on("clickoutside", this.clickOutside, this);
            bb.on("click", this.hide, this);
            bb.on("mouseenter", this.cancelMenuTimer, this);
            bb.on("mouseleave", this.startMenuHideTimer, this);
        },
        hide: function() {
            if (this.get("visible")) {
                this.get(BOUNDINGBOX).transition({
                    duration: 0.1,
                    easing: 'ease-out',
                    opacity: 0
                }, Y.bind(Menu.superclass.hide, this));
            }
        },
        show: function() {
            if (!this.get("visible")) {
                Menu.superclass.show.call(this);
                this.get(BOUNDINGBOX).transition({
                    duration: 0.1,
                    easing: 'ease-out',
                    opacity: 1
                });
            }
        },
        // *** Public methods *** //
        /**
         *
         *  Displays the menu next to the provided node and add mouseenter and
         *  mouseleave callbacks to the node
         *
         * @function
         */
        attachTo: function(node) {
            this.currentNode = node;

            this.set("align", {
                node: node,
                points: this.get("points")
            });
            this.cancelMenuTimer();
            this.show();

            //node.on("mouseenter", this.show, this);
            //node.on("mouseleave", this.hide, this);
        },
        // *** Private methods *** //
        clickOutside: function(e) {
            if (this.currentNode !== e.target) {
                this.hide();
            }
        },
        startMenuHideTimer: function(fireEvent) {
            //console.log("startMenuHideTimer",this.get("contentBox").one("button").getHTML());
            this.cancelMenuTimer();
            this.timer = Y.later(200, this, this.hide);

            if (!!fireEvent) {
                this.fire("timerStarted");
            }
        },
        cancelMenuTimer: function() {
            //console.log("cancelMenuTimer", this.get("contentBox").one("button").getHTML());
            if (this.timer) {
                this.timer.cancel();
            }
            this.fire("timerCanceled");
        }
    },
        {
            /** @lends Y.Wegas.Menu */
            ATTRS: {
                defaultChildType: {
                    value: Y.Wegas.Button
                },
                points: {
                    value: ["tl", "bl"]
                },
                constrain: {
                    value: true
                },
                preventOverlap: {
                    value: true
                },
                zIndex: {
                    value: 50
                },
                render: {
                    value: true
                },
                visible: {
                    value: false
                }
            }
        });
    Y.namespace('Wegas').Menu = Menu;

});
